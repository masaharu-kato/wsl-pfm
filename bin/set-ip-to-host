#!/bin/bash

ROOT_DIR=$(realpath "$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )/..")
DATA_DIR="$ROOT_DIR/data"
DISTROS_DIR="$DATA_DIR/distros"

if [[ ! $WSL_HOST_USER ]]; then
  # Get the User name of host (Windows), removing the last CR character.
  WSL_HOST_USER=$(powershell.exe '$env:UserName' | sed 's/\r$//')
  export WSL_HOST_USER
fi

DISTRO="$WSL_DISTRO_NAME"
THIS_DISTRO_DIR="$DISTROS_DIR/$WSL_HOST_USER/$DISTRO"

mkdir -p "$THIS_DISTRO_DIR"

c_ip=$(ip a show eth0 | grep -w -m1 inet | awk '{print $2}' | awk -F'/' '{print $1}')
saved_ip=""
if [[ -e "$THIS_DISTRO_DIR/ip" ]]; then
    saved_ip=$(cat "$THIS_DISTRO_DIR/ip")
fi
if [[ "$c_ip" != "$saved_ip" ]]; then
    echo -n "$c_ip" > "$THIS_DISTRO_DIR/ip"
fi
